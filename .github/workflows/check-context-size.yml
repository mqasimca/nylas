name: Context Size Check

on:
  pull_request:
    paths:
      - 'docs/*.md'
      - '.claude/**/*.md'
      - 'CLAUDE.md'

jobs:
  check-size:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check context size
        run: |
          # Calculate total size of auto-loaded files (excluding FAQ, EXAMPLES, TROUBLESHOOTING, INDEX per .claudeignore)
          TOTAL=$(ls -l CLAUDE.md .claude/rules/*.md docs/AI.md docs/ARCHITECTURE.md docs/COMMANDS.md docs/DEVELOPMENT.md docs/SECURITY.md docs/TIMEZONE.md docs/TUI.md docs/WEBHOOKS.md 2>/dev/null | awk '{sum+=$5} END {print int(sum/1024)}')
          TIMEZONE=$(ls -l docs/TIMEZONE.md 2>/dev/null | awk '{print int($5/1024)}')

          echo "üìä Context Size Report"
          echo "======================"
          echo ""
          echo "Auto-loaded files (excluding FAQ, EXAMPLES, TROUBLESHOOTING, INDEX per .claudeignore):"
          ls -lh CLAUDE.md .claude/rules/*.md docs/AI.md docs/ARCHITECTURE.md docs/COMMANDS.md docs/DEVELOPMENT.md docs/SECURITY.md docs/TIMEZONE.md docs/TUI.md docs/WEBHOOKS.md 2>/dev/null | awk '{print $5, $9}'
          echo ""
          echo "Total auto-loaded context: ${TOTAL}KB (~$((TOTAL / 4)) tokens)"
          echo "TIMEZONE.md: ${TIMEZONE}KB"
          echo ""

          # Budget check
          PASSED=true

          if [ $TOTAL -gt 60 ]; then
            echo "‚ùå FAILED: Total context exceeds 60KB budget (currently ${TOTAL}KB)"
            echo "   Please reduce documentation size or move content to on-demand files"
            PASSED=false
          else
            echo "‚úÖ Total context within 60KB budget (${TOTAL}KB)"
          fi

          if [ $TIMEZONE -gt 5 ]; then
            echo "‚ö†Ô∏è  WARNING: TIMEZONE.md exceeds 5KB target (currently ${TIMEZONE}KB)"
            echo "   Consider moving more content to docs/timezone/detailed.md"
          else
            echo "‚úÖ TIMEZONE.md within 5KB target (${TIMEZONE}KB)"
          fi

          echo ""
          echo "Budget Summary:"
          echo "  Total: ${TOTAL}KB / 60KB"
          echo "  TIMEZONE.md: ${TIMEZONE}KB / 5KB"

          if [ "$PASSED" = false ]; then
            exit 1
          fi
